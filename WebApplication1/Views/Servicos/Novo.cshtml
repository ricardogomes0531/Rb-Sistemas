<h2>Cadastro de Serviços</h2>

<form id="formServico" asp-action="Create" asp-controller="Servicos" method="post">
    <div class="mb-3">
        <label for="Nome" class="form-label">Nome do Serviço</label>
        <input type="text" class="form-control" id="Nome" name="Nome" required />
    </div>

    <div class="mb-3">
        <label for="Tempo" class="form-label">Tempo de Realização</label>
        <select class="form-select" id="Tempo" name="Tempo" required>
            <option value="">Selecione...</option>
            @for (int i = 5; i <= 60; i += 5)
            {
                <option value="@i">@i minutos</option>
            }
        </select>
    </div>

    <div class="mb-3">
        <label for="Valor" class="form-label">Valor</label>
        <input type="text" class="form-control" id="Valor" name="Valor" placeholder="R$ 0,00" inputmode="numeric" required />
        <div class="form-text">Digite apenas números; a formatação em reais aparece automaticamente.</div>
    </div>

    <div class="mb-3">
        <label class="form-label">Profissionais</label>
        <div id="listaProfissionais">
            <!-- Checkboxes serão carregados via AJAX -->
        </div>
    </div>

    <button type="submit" class="btn btn-primary">Salvar</button>
</form>

@section Scripts {
    <script>
        // --- Util: formata e interpreta valores em BRL ---
        function formatCurrencyBRL(cents) {
            // cents é inteiro em centavos
            const value = (cents / 100);
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function parseInputToCents(raw) {
            // Mantém apenas dígitos
            const digits = (raw || '').replace(/\D/g, '');
            return digits.length ? parseInt(digits, 10) : 0;
        }

        function parseMaskedToNumber(masked) {
            // Converte "R$ 1.234,56" -> 1234.56 (Number)
            const numeric = (masked || '')
                .replace(/[^\d,.-]/g, '')   // mantém dígitos, vírgula, ponto, sinal
                .replace(/\./g, '')         // remove separador de milhar
                .replace(',', '.');         // vírgula -> ponto
            const val = parseFloat(numeric);
            return isNaN(val) ? 0 : val;
        }

        $(document).ready(function () {
            // Carregar lista de profissionais via AJAX
            $.get("/Profissionais/GetProfissionais", function (data) {
                const container = $("#listaProfissionais");
                container.empty();
                $.each(data, function (i, prof) {
                    container.append(
                        `<div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   name="ProfissionaisSelecionados" value="${prof.id}" id="prof_${prof.id}">
                            <label class="form-check-label" for="prof_${prof.id}">
                                ${prof.nome}
                            </label>
                        </div>`
                    );
                });
            });

            // Máscara de moeda BRL para o campo Valor
            const $valor = $("#Valor");
            let currentCents = 0;

            // Inicializa como R$ 0,00
            $valor.val(formatCurrencyBRL(currentCents));

            // Aplica máscara a cada digitação
            $valor.on("input", function () {
                currentCents = parseInputToCents($valor.val());
                $valor.val(formatCurrencyBRL(currentCents));
            });

            // Seleciona tudo ao focar para facilitar edição
            $valor.on("focus", function () {
                setTimeout(() => this.select(), 0);
            });

            // Captura do envio do formulário
            $("#formServico").on("submit", function (e) {
                e.preventDefault();

                const formData = {
                    Nome: $("#Nome").val(),
                    Tempo: $("#Tempo").val(),
                    // Converte a máscara "R$ x.xxx,yy" para número com ponto decimal
                    Valor: parseMaskedToNumber($("#Valor").val()),
                    ProfissionaisSelecionados: []
                };

                $("input[name='ProfissionaisSelecionados']:checked").each(function () {
                    formData.ProfissionaisSelecionados.push(parseInt($(this).val(), 10));
                });

                $.ajax({
                    url: "/Servicos/Create",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function () {
                        alert("Serviço cadastrado com sucesso!");
                        window.location.href = "/Servicos";
                    },
                    error: function () {
                        alert("Erro ao cadastrar serviço.");
                    }
                });
            });
        });
    </script>
}
